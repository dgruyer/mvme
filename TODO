==========================
==== Do these first! =====
==========================

New VME Module Meta Information System (VMMIS)
----------------------------------------------
* Reqs:
  - Replaces the current template system. Should do everything it currently does.
  - Goal is to remove most module information from the code. Instead load it from files.
    It should not be neccessary to edit the code at all to add/edit/remove module types.
  - Plugins/Code paths for certains modules can be loaded into the application to
    allow module dependent behaviour.
  - New feature: Add custom scripts to modules. For example a script to setup Channel Thresholds.
    Execution order is important here!
    Config file format right now is hash based. I think the entries are sorted
    by interal name (daq_start, daq_stop). An array that can be sorted would be better.

  - Current template files for reference:
      event_daq_start.vme             # Multicast stop acq, reset ctrs, reset fifo, start acq, readout reset
      event_daq_stop.vme              # multicast stop acq

      readout_cycle_start.vme         # Cycle Start. Empty
      readout_cycle_end.vme           # Cycle End. Multicast readout reset

      # Scripts for the mesytec "group"
      mesytec_readout_settings.vme    # Readout settings. Same for all mesytec module
      mesytec_readout.vme             # Readout loop. mbltfifo read of the module
      mesytec_reset.vme

      # Module specific scripts. Override group scripts.
      madc32_parameters.vme
      mdi2_parameters.vme
      mdpp16_parameters.vme
      mdpp32_parameters.vme
      mqdc32_parameters.vme
      mtdc32_parameters.vme
      mesytec_counter_parameters.vme
      mesytec_counter_readout.vme

  - New feature: Module specific filters. (Analysis related, not VME Config related)
    Default filter set. (Add default filters)
    Additional filter sets. (Add filters)


* Plan





#0  0x00007ffff3e36067 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
#1  0x00007ffff3e37448 in __GI_abort () at abort.c:89
#2  0x00007ffff4ef0f4e in QMessageLogger::fatal(char const*, ...) const () from /home/florian/Qt/5.7/gcc_64/lib/libQt5Core.so.5
#3  0x00007ffff4eec821 in qt_assert_x(char const*, char const*, char const*, int) () from /home/florian/Qt/5.7/gcc_64/lib/libQt5Core.so.5
#4  0x00000000005e20bf in QVector<analysis::Parameter>::operator[] (this=0x60e000031a40, i=1) at ../../../Qt/5.7/gcc_64/include/QtCore/qvector.h:429
#5  0x00000000005cf3be in analysis::Difference::step (this=0x61000000ba40) at ../../mvme2/src/analysis/analysis.cc:915
#6  0x00000000005d82de in analysis::Analysis::endEvent (this=0x6060000dfd00, eventId=...) at ../../mvme2/src/analysis/analysis.cc:1897
#7  0x000000000053c6bc in MVMEEventProcessor::processDataBuffer (this=0x60400002ecd0, buffer=0x603000022d50) at ../../mvme2/src/mvme_event_processor.cc:278
#8  0x000000000053cec7 in MVMEEventProcessor::startProcessing (this=0x60400002ecd0) at ../../mvme2/src/mvme_event_processor.cc:336
#9  0x000000000066e4d3 in MVMEEventProcessor::qt_static_metacall (_o=0x60400002ecd0, _c=QMetaObject::InvokeMetaMethod, _id=7, _a=0x60200190cad0)
    at moc_mvme_event_processor.cpp:115

#3  0x00007ffff4eec821 in qt_assert_x(char const*, char const*, char const*, int) ()
   from /home/florian/Qt/5.7/gcc_64/lib/libQt5Core.so.5
#4  0x00000000005eb379 in QVector<analysis::Parameter>::operator[] (this=0x6100000089c0, i=1)
    at ../../../Qt/5.7/gcc_64/include/QtCore/qvector.h:429
#5  0x00000000005db4be in analysis::ConditionFilter::step (this=0x610000360240) at ../../mvme2/src/analysis/analysis.cc:1423
#6  0x00000000005e0590 in analysis::Analysis::endEvent (this=0x6070000901c0, eventId=...) at ../../mvme2/src/analysis/analysis.cc:1916
#7  0x00000000005440fa in MVMEEventProcessor::processDataBuffer (this=0x604000049150, buffer=0x603000021e20)
    at ../../mvme2/src/mvme_event_processor.cc:280

* When quitting: if vme script editor asks for confirmation and the user
  presses cancel the mainwindow will still close


* AddEditOperatorWidget: highlight selected input on button hover
* VMUSBReadoutWorker: Add daqconfig consistency checks. Abort if the checks fail.
* New Extractor for a MesytecCounter module -> no default filter present! Name
  is only partially filled.

* Clearly document Extractor behaviour:
  - How does it use the individual filters?
  - How are data and address values formed?
  - How does WordIndex behave?
  - What does RequiredCompletionCount do?
* Close histograms on opening a new analysis config.
* Bug: H1D does not work when unitMin > unitMax
* Bug: H1D Print to File is broken. Also check save to file.
* Histograms:
  - Read up on binning error calculations. See how ROOT does it.

* DAQ Config gui: restore minimized vme script editors on script (double?) click
* DAQConfig: Add a "disabled" condition to events to allow temporarily disabling them.
* DAQConfig enh: Global Scripts DAQ Start, DAQ Stop and Manual should have a folder-like icon.
* DAQConfig: most templates are important as without them the readout does not
  work at all (mcast, start, stop, reset). Display a clear message if any of
  the required templates is missing.

* Log throttling!!!!

* When closing the main window via the window manager do quit the application.
* Check for off-by-one errors in the 2D projection code
* Make listfile-dumper handle the v1 format.

* lastlog.log:
  Write every logged message to lastlog.log. Do this in the main thread. Flush
  to disk frequently.
  At startup move lastlog.log to lastlog.1.log.
  Keep 5 logfiles around. 4 -> 5, 3 -> 4, 2 -> 3, 1 -> 2, 0 -> 1

* Histo1DWidget: zoom out after setHistogram()
  But not when the usage is the one in x- and y-projections where the histo is
  replaced with a similar one.
* Histo1DWidget: The curve for the last bin is not drawn. Try to finally find a fix for this.

* Calibration:

* Copy/Paste and Move Operators
  - Moving operators could violate the rule that inputs should come from the
    current user level or the ones below. For consistency keep that rule intact
    while moving.
  - Copy needs a clone() operation for analysis elements.
  - On copying an extractor the edit dialog should be opened.

* Open new histograms immediately. Do this when creating a sub-histogram.


* select input UI: disable other tree highlights while it's active.
* track down weird scrolling/selection bug when selcting inputs.
  What happens is that the treeview scrolls up and the wrong input is selected.
  This happens when clicking a node.

* Fix replay stats display and replay timer. It wasn't designed with pausing
  and stepping in mind.
* ZIP file support:
  On close:
  - write some user description text file to the zip. "Run description", "Run notes", "DAQ notes"

 - UserLevel hide/show GUI

 - "modified" concept for the analysis and it's elements
 - save/saveas/load error reporting
 - Make the AnalysisUI show consistency errors between vme and analysis configs.

* EventWidget and AnalysisWidget repopulate:
  - Restore open PipeDisplays:
    Store (ObjectId, OutputIndex) to get the output pipe and (pos, size) to restore the widget.
  - Restore splitter states when recreating event widgets.
  - Restore node expansion state
    Could store QUuids for expanded object nodes and after repop rebuild the
    VoidStar set of expanded nodes by getting the pointers via the ids.

==========================
==== Do these later! =====
==========================
* H1D: Take the median of the visible left and right edges. Subtract that value
  from the calculated statistics values. This is supposed to remove the noise
  to the left and right of a peak.
* HistoViewer: Ability to save filled Histograms to disk and reload them later.
  This will allow using histogram tools (fits, etc.) on loaded histos. It also
  allows comparing histos from different runs etc.
* Calculated listfile size in stats display and size shown by windows explorer
  are not the same at all. Why?
* // FIXME: when using subranges the getBinUnchecked() calculation often yields negative bins. why?
  Verify this does in fact happen.
* DAQStats:
  - add pause/resume
  - figure out why buffers/s never has a fractional part
    -> part of the system. addBuffersRead() and addBytesRead() each call maybeUpdateIntervalCounters().
       If we're reading less than 1 buffer per second the resulting bytesPerSecond will be 0 for that interval.
    How to make this better?
- License info needs Apache License for PCG. Maybe others. Check what is needed here!
  Also use info from resources/README
- Refactor DAQConfig -> VMEConfig and DAQConfigTree to VMEConfigTree
- VMUSB: if there are connect/reconnect errors write them to the log view
  Do this when porting to libusb-1.0 as that should also provide better error messages.
- VMUSB: make the mutex non-recursive!

>>>>> Begin Analysis NG <<<<<
 - Add Operator::getDescription()
 - make sure the UI works with empty vme and event configs
 - display required memory in Histo2D dialog.
 - combine "single word" and "dual word" filters. the distinction is not needed
   anymore as both are MultiWordDataFilters now
 - Load default filters from templates
<<<<< End AnalysisNG >>>>>

* Git version is not updated when rebuilding the project! FIX THIS!
  -> I failed at this. qmake is horrible.

* GUI
  * add versioning to the GUI state saved via QSettings. If the version changes
    use the default layout instead of restoring a possibly incompatible state.
  * add a "reset gui state" button somewhere

* add ability to add notes to VME/analysis config (maybe other objects too)
* VMEScript: add print command
* Limit the number of messages/s appended to the logview. With multithreading:
  do messages fill up one of the threads event queues? Can this be limited
  somehow? Better to directly limit the generation of these messages?
* Fix diagnostics window blocking when there are a lot of error messages being generated.

* workspace
    * copy templates from app dir to workspace (maybe?)

* Histos:
  * add histogram cuts
  * add histogram fitting

* Mesytec Module Firmware Revision & Hardware ID
* prefix and (maybe) run number for listfiles

* Mesytec Werbung ^^ Hintergrundbilder, Wasserzeichen, etc. (CSS Theme?)
* Hist2d: look for standard color scales as used in publications, ROOT, etc.
  https://root.cern.ch/doc/master/TColor_8cxx_source.html#l02400
* How to handle filters without matching module? Right now they're not
  displayed until a module with the corresponding (eventIndex,moduleIndex) is
  created.
  Related: Remove Hist2d on filter removal?
  => would all be fixed when moving from (eventIndex, moduleIndex) to using object ids.

* threading and vme commands
  * run vme scripts in a separate thread when invoked from the gui

* ReadoutWorker split into generic and controller specific parts:
    Generic part is responsible for:
        - running vme init scripts
        - creating and opening the output listfile

    Controller specific parts:
        - init
        - readout
        - shutdown
        - pause
        - resume
  Do this when implementing support for another controller, not before.

* save and restore the position and size of windows
* save and restore the zoom and pan of histograms
* save and restore open histograms
* make use of the "enabled" flag for vme scripts, modules, events, etc

==========================
===== Maybe do these =====
==========================

======================================
==== Done, but kept for reference ====
======================================
>>>>> Begin Analysis NG <<<<<
* Filter on number of occurence: the filter is considered complete only if it
  matched N times.
  Needed for devices that can yield data for the same address in a single
  event. If the filter does not specify an occurence condition but matches
  multiple times only the first matched value will be kept.
  XXX: Impossible to simply accumulate all raw values for a channel into a Hist1D!
  -> Not an issue according to Robert as multi hits per channel need to be
     handled explicitly anyways.
===== Plan to handle array -> single value conversion =====
- Pipes are only used as output of Operators/Sources
- Pipes connect to Slots of Operators
- The slot specifies what kind of inputs it accepts: Array, Value, Both
- When an output pipe is connected to an input slot and the slot accepts Values
  the index into the input parameters must be supplied.
- Slots live in the receiving Operator. They now hold the source Pipe pointers
- The 'destination' member of Pipes now contains pointers to Slot instead of OperatorInterface
- Slots need to contain pointers to their owning Operator to be able to traverse the tree forward:
  sourceOp.outputPipe[i].destinations[j].destOp
=====
<<<<< End AnalysisNG >>>>>
